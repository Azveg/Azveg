---
title: Создание графиков в пакете UpSetR
author: Best Practices IT
date: '2022-08-03'
slug: []
categories:
  - R
tags:
  - R Markdown
  - UpSet
  - visualization
  - R
cover: ''
keywords:
  - ''
  - ''
summary: 'Первым рассмотрим пакет UpSetR, разберем примеры построения качественных и красивых графиков'
---



<div id="графики-upset-в-пакете-upsetr" class="section level2">
<h2>Графики UpSet в пакете UpSetR</h2>
<p>Создание графиков UpSet в пакете UpSetR процесс достаточно простой и интуитивно понятный, пакет поможет создавать качественные и красивые визуализации для полного и глубокого анализа данных. </br></p>
<div id="содержание" class="section level3">
<h3>Содержание</h3>
<ul>
<li><a href="#построение-простого-графика">Построение простого графика</a></li>
<li><a href="#атрибуты-графиков">Атрибуты графиков</a>
<ul>
<li><p><a href="#встроенная-гистограмма-атрибутов">Встроенная гистограмма атрибутов</a></p></li>
<li><p><a href="#встроенная-точечная-диаграмма">Встроенная точечная диаграмма</a></p></li>
<li><p><a href="#создание-пользовательских-графиков">Создание пользовательских графиков</a></p></li>
<li><p><a href="#встроенная-диаграмма-boxplot">Встроенная диаграмма boxplot</a></p></li>
</ul></li>
<li><a href="#запросы-к-данным">Запросы к данным</a></li>
<li><a href="#встроенные-элементы">Встроенные элементы</a></li>
<li><a href="#создание-пользовательских-запросов-к-элементам-и-атрибутам-набора">Создание пользовательских запросов к элементам и атрибутам набора</a></li>
<li><a href="#использование-параметра-выражения-для-запросов-к-пересечениям-подмножеств-и-элементам">Использование параметра выражения для запросов к пересечениям подмножеств и элементам</a></li>
<li><a href="#добавление-легенды">Добавление легенды</a></li>
<li><a href="#добавление-метаданных-набора-на-график">Добавление метаданных набора на график</a></li>
<li><a href="#добавление-тепловой-карты">Добавление тепловой карты</a>
<ul>
<li><a href="#логическая-тепловая-карта">Логическая тепловая карта</a></li>
</ul></li>
<li><a href="#применение-метаданных-к-матрице">Применение метаданных к матрице</a></li>
</ul>
<p></br></p>
</div>
<div id="построение-простого-графика" class="section level3">
<h3>Построение простого графика</h3>
<p>Загрузим набор данных предоставляемый этим пакетом.</p>
<pre class="r"><code>movies &lt;- read.csv(system.file(&quot;extdata&quot;, &quot;movies.csv&quot;, package = &quot;UpSetR&quot;), 
    header = T, sep = &quot;;&quot;)</code></pre>
<p>Для построения графика будем использовать функцию upset, подробнее об этой функции в <code>?upset</code></p>
<p>Выберем 6 наибольших наборов.</p>
<pre class="r"><code>upset(movies, nsets = 6, number.angles = 0, point.size = 3.5, line.size = 2, 
    mainbar.y.label = &quot;Genre Intersections&quot;, sets.x.label = &quot;Movies Per Genre&quot;, 
    text.scale = c(1.3, 1.3, 1, 1, 2, 0.75))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
На оси “Movies Per Genre” показано количество фильмов каждого жанра </br>
На оси “Genre Intersections” количество фильмов в разрезе пересечений с другими жанрами </br>
Видно, что наибольшее количество набирается когда пересечений с другими жанрами нет либо оно минимальное, а самые популярные жанры: Драма, Комедия и Ужасы </br></p>
</blockquote>
<p></br></p>
<p><strong>Выбрать конкретные наборы и задать параметры группировки</strong></p>
<blockquote>
<p>mb.ratio = c(0.75, 0.25) - через этот параметр задаем соотношение между столбчатой диаграммой и диаграммой пересечений. Сумма коэффициентов должна равняться единице.</p>
</blockquote>
<pre class="r"><code>upset(movies, sets = c(&quot;Action&quot;, &quot;Adventure&quot;, &quot;Comedy&quot;, &quot;Drama&quot;, &quot;Mystery&quot;, 
    &quot;Thriller&quot;, &quot;Romance&quot;, &quot;War&quot;, &quot;Western&quot;), mb.ratio = c(0.75, 0.25), order.by = &quot;degree&quot;)</code></pre>
<pre><code>## Warning in Make_base_plot(Main_bar_plot = x$Main_bar, Matrix_plot = x$Matrix, :
## Plot might be out of range if ratio &gt; 0.7 or &lt; 0.3</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-1.png" width="1152" style="display: block; margin: auto;" /></p>
<pre class="r"><code>upset(movies, sets = c(&quot;Action&quot;, &quot;Adventure&quot;, &quot;Comedy&quot;, &quot;Drama&quot;, &quot;Mystery&quot;, 
    &quot;Thriller&quot;, &quot;Romance&quot;, &quot;War&quot;, &quot;Western&quot;), mb.ratio = c(0.55, 0.45), order.by = c(&quot;degree&quot;, &quot;freq&quot;))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-2.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
В обоих графиках задаем список наборо, соотношения между столбчатой диаграммой и диаграммой пересечений поставили разные
Сортировка задана по возрастанию наборов и во втором графике по частоте</p>
</blockquote>
<p></br></p>
<p><strong>Задать порядок наборов при сортировке</strong></p>
<blockquote>
<p>keep.order - при значении TRUE упорядочивает наборы в том порядке в котором они записаны в sets
при значении FALSE по их размеру</p>
</blockquote>
<pre class="r"><code>upset(movies, sets = c(&quot;Action&quot;, &quot;Adventure&quot;, &quot;Comedy&quot;, &quot;Drama&quot;, &quot;Mystery&quot;, 
    &quot;Thriller&quot;, &quot;Romance&quot;, &quot;War&quot;, &quot;Western&quot;), mb.ratio = c(0.55, 0.45), order.by = &quot;freq&quot;, 
    keep.order = TRUE)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
Наборы на графике отсортированны согласно заданному нами списку, а размеры пересечений по убыванию.</p>
</blockquote>
<p></br></p>
<p><strong>Группировка по наборам</strong></p>
<blockquote>
<p>nintersects - количество пересечений выведенных на график, по умолчанию выводятся все пересечения
group.by - способ группировки по наборам или по количеству пересечений наборов
cutoff - Количество пересечений из каждого набора (для отсечения) при агрегировании по наборам</p>
</blockquote>
<pre class="r"><code>upset(movies, nintersects = 70, group.by = &quot;sets&quot;, cutoff = 7)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
На графике видим размер пересечений сгруппированые по жанрам, в каждой группе не более 7 значений.
Так пересекающихся жанров несколько , то значения в нескольких пересекающихся друг с другом жанрах будут повторяться.</p>
</blockquote>
<p></br></p>
<p><strong>Отображение Пустых Пересечений</strong></p>
<blockquote>
<p>empty.intersections = “on” - свойство позволяет дополнительно отображать пустые пересечения</p>
</blockquote>
<pre class="r"><code>upset(movies, empty.intersections = &quot;on&quot;, order.by = &quot;freq&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
Видмо, что на графике появились пустые пересечения т.е. размер которых равен нулю.</p>
</blockquote>
<p></br></p>
</div>
<div id="атрибуты-графиков" class="section level3">
<h3>Атрибуты графиков</h3>
<pre class="r"><code>library(ggplot2)
library(grid)
library(plyr)</code></pre>
<p>С помощью атрибутов можно выводить дополнительные диаграммы на график.</p>
<p>Параметр attribute.plots содержит три поля: gridrows, plots, and ncols</p>
<ul>
<li><code>gridrows</code> указывает на сколько нужно увеличить высоту окна графика чтобы добавить место под диаграммы атрибутов. График UpSetR отрисовывается на сетка размером 100 х 100. Например если установить парамерт <code>gridrows = 50</code>, то размер новой сетки окна будет 150 х 100.</li>
<li><code>plots</code> также содержит список параметров, в нем задаются <code>plot</code>, <code>x</code>, <code>y</code> и <code>queries</code>.</li>
<li><code>plot</code> функция возвращающая ggplot</li>
<li><code>x</code> задает параметр к оси X</li>
<li><code>y</code> задает параметр к оси Y</li>
<li><code>queries</code>: указывает необходимо ли применять к графиком атрибутов результаты параметра <code>queries</code> функции <code>upset</code>. Если значение True, то к графику будет применен параметр <code>queries</code>, если False, то нет. Сам же параметр <code>queries</code> имеет атрибут <code>query</code> который определяет какая функция будет применена к графику, например intersects или самописная функция.</li>
<li><code>ncols</code> указывает, как должны быть расположены графики в пространстве строк сетки. Если введены два графика атрибутов и значение ncols равно 1, то графики будут отображаться один над другим. В качестве альтернативы, если введены два графика атрибутов и значение ncols равно 2, графики атрибутов будут отображаться рядом. </br></li>
</ul>
<div id="встроенная-гистограмма-атрибутов" class="section level4">
<h4>Встроенная гистограмма атрибутов</h4>
<pre class="r"><code>upset(movies, main.bar.color = &quot;black&quot;, queries = list(list(query = intersects, 
    params = list(&quot;Drama&quot;), active = T)), 
    attribute.plots = list(gridrows = 50, 
                           plots = list(
                             list(plot = histogram, x = &quot;ReleaseDate&quot;, queries = F), 
                             list(plot = histogram, x = &quot;AvgRating&quot;, queries = T)), 
                           ncols = 2)
    )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-9-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
На графике выделенно синим цветом пересечение по жанру драма
В дополнительной диаграмме среднего рейтинга фильмов выделена доля фильмов жанра драма
И на левом дополнительном графике показана частота выхода фильмов в зависимости от года</p>
</blockquote>
<p></br></p>
</div>
<div id="встроенная-точечная-диаграмма" class="section level4">
<h4>Встроенная точечная диаграмма</h4>
<p>В этом коде задаем форматирование для пересечений нужным цветом. Потом в дополнительных диаграммах атрибутов определяем использовать это форматирование или нет.</p>
<pre class="r"><code>upset(movies, main.bar.color = &quot;black&quot;, 
      queries = list(
        list(query = intersects, params = list(&quot;Drama&quot;), color = &quot;red&quot;, active = F), 
        list(query = intersects, params = list(&quot;Action&quot;, &quot;Drama&quot;), active = T), 
        list(query = intersects, params = list(&quot;Drama&quot;, &quot;Comedy&quot;, &quot;Action&quot;), color = &quot;orange&quot;, active = T)
        ),
      attribute.plots = list(gridrows = 45, 
                             plots = list(list(plot = scatter_plot, x = &quot;ReleaseDate&quot;, y = &quot;AvgRating&quot;, queries = T),
                                          list(plot = scatter_plot, x = &quot;AvgRating&quot;, y = &quot;Watches&quot;, queries = F)
                                          ), 
                             ncols = 2), query.legend = &quot;bottom&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
На графике выделили три типа пересечений и спроецировали их на одну дополнительную диаграмму.
На первой доп диаграмме показана зависимость среднего рейтинга от даты выхода фильма, а также какую часть в нем занимают интересующие нас пересечения
На второй доп диаграмме зависимость просмотров от среднего рейтинга, логично, что чем выше рейтинг тем выше количество просмотров</p>
</blockquote>
<p></br></p>
</div>
<div id="создание-пользовательских-графиков" class="section level4">
<h4>Создание пользовательских графиков</h4>
<p>Здесь вместо одной из точечных диаграмм, добавляем диаграмму постороенную по пользовательской функцие.</p>
<pre class="r"><code>myplot &lt;- function(mydata, x, y) {
    plot &lt;- (ggplot(data = mydata, aes_string(x = x, y = y, colour = &quot;color&quot;)) + 
        geom_point() + scale_color_identity() + theme(plot.margin = unit(c(0, 0, 0, 0), &quot;cm&quot;)))
}

another.plot &lt;- function(data, x, y) {
    data$decades &lt;- round_any(as.integer(unlist(data[y])), 10, ceiling)
    data &lt;- data[which(data$decades &gt;= 1970), ]
    myplot &lt;- (ggplot(data, aes_string(x = x)) + geom_density(aes(fill = factor(decades)), 
        alpha = 0.4) + theme(plot.margin = unit(c(0, 0, 0, 0), &quot;cm&quot;), legend.key.size = unit(0.4, 
        &quot;cm&quot;)))
}

upset(movies, main.bar.color = &quot;black&quot;, 
      queries = list(list(query = intersects, params = list(&quot;Drama&quot;), color = &quot;red&quot;, active = F), 
                     list(query = intersects, params = list(&quot;Action&quot;, &quot;Drama&quot;), active = T), 
                     list(query = intersects, params = list(&quot;Drama&quot;, &quot;Comedy&quot;, &quot;Action&quot;), color = &quot;orange&quot;, active = T)), 
                attribute.plots = list(gridrows = 45, 
                                       plots = list(
                                         list(plot = myplot, x = &quot;ReleaseDate&quot;, y = &quot;AvgRating&quot;, queries = T), 
                                         list(plot = another.plot, x = &quot;AvgRating&quot;, y = &quot;ReleaseDate&quot;, queries = F)), 
                                       ncols = 2))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-11-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
На график добавили диаграмму постороенную по своей функции. Она отображает средний рейтинг фильмов в зависимости от даты выхода в разрезе десятилетий</p>
</blockquote>
<p></br></p>
<p>Объединение встроенного точечного графика и графика гистограммы с пользовательским графиком myplot, определенным в приведенном выше примере.</p>
<pre class="r"><code>upset(movies, main.bar.color = &quot;black&quot;, mb.ratio = c(0.5, 0.5), 
      queries = list(list(query = intersects, params = list(&quot;Drama&quot;), color = &quot;red&quot;, active = F), 
                     list(query = intersects, params = list(&quot;Action&quot;, &quot;Drama&quot;), active = T), 
                     list(query = intersects, params = list(&quot;Drama&quot;, &quot;Comedy&quot;, &quot;Action&quot;), color = &quot;orange&quot;, active = T)), 
    attribute.plots = list(gridrows = 50, 
                           plots = list(
                             list(plot = histogram,x = &quot;ReleaseDate&quot;, queries = F), 
                             list(plot = scatter_plot, x = &quot;ReleaseDate&quot;, y = &quot;AvgRating&quot;, queries = T), 
                             list(plot = myplot, x = &quot;AvgRating&quot;, y = &quot;Watches&quot;, queries = F)), 
                           ncols = 3))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-12-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
На этом графике добавлены дополнительные диаграммы.
Теперь можно анализировать данные с нескольких сторон: частоты выхода фильмов и среднего рейтинга в зависимости от даты выхода, а также количество просмотров от серднего рейтинга фильмов</p>
</blockquote>
<p></br></p>
</div>
<div id="встроенная-диаграмма-boxplot" class="section level4">
<h4>Встроенная диаграмма boxplot</h4>
<p>boxplot, показывает распределение атрибута по всем пересечениям. Может отображать одновременно не более двух сводок графиков. Параметр boxplot.summary принимает вектор из одного или двух имен атрибутов.</p>
<pre class="r"><code>upset(movies, boxplot.summary = c(&quot;AvgRating&quot;, &quot;ReleaseDate&quot;))</code></pre>
<pre><code>## Warning: Continuous limits supplied to discrete scale.
## Did you mean `limits = factor(...)` or `scale_*_continuous()`?
## Continuous limits supplied to discrete scale.
## Did you mean `limits = factor(...)` or `scale_*_continuous()`?</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-13-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
Под каждым столбцом с пересечениями находится свой элемент диаграммы ящик с усами, он показывает распределение значений по диапозону
Например для фильмо с жанров драма видим, что медиана среднего рейтинга находится между 3 и 4, а медиана даты выхода ближе к 2000 году</p>
</blockquote>
<p></br></p>
</div>
</div>
<div id="запросы-к-данным" class="section level3">
<h3>Запросы к данным</h3>
<p>Разберем параметр <code>query</code>, он часто использовался на предыдущих диаграммах, пора его подробно описать.</p>
<ul>
<li><code>query</code> указывает, какой запрос будет выполняться</li>
<li><code>params</code> это список параметров, с которыми будет работать запрос</li>
<li><code>color</code> это цвет, который будет представлять запрос на графике. Если цвет не указан, будет выбран цвет из палитры цветов по умолчанию.</li>
<li><code>active</code> определяет, как запрос будет представлен на графике. Если значение active равно TRUE, строка размера пересечения будет перекрыта строкой, представляющей запрос. Если значение active равно FALSE, на панели размера пересечения будет размещена точка дрожания.</li>
</ul>
<p>В этом примере показано, как использовать встроенный запрос пересечений intersects для поиска или отображения элементов в определенных пересечениях. В этом примере цвет, выбранный для активного запроса, выбран из цветовой палитры по умолчанию.</p>
<pre class="r"><code>upset(movies, 
      queries = list(list(query = intersects, params = list(&quot;Drama&quot;,&quot;Comedy&quot;, &quot;Action&quot;), color = &quot;orange&quot;, active = T), 
                     list(query = intersects, params = list(&quot;Drama&quot;), color = &quot;red&quot;, active = F), 
                     list(query = intersects, params = list(&quot;Action&quot;, &quot;Drama&quot;), active = T)))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-14-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
с помощью запросов подсветили интересующие нас пересечения, где они активированы там цветом выделены столбец гистограммы и столбец на графике пересечений наборов, а где запрос не активирован, то там галочкой показана величина пересечения.</p>
</blockquote>
<p></br></p>
</div>
<div id="встроенные-элементы" class="section level3">
<h3>Встроенные элементы</h3>
<p>Если необходимо визуализировать как конкретные значения атрибутов распределяются между пересечениями, то тогда можно использовать запрос элемента elements.</p>
<pre class="r"><code>upset(movies, 
      queries = list(list(query = elements, params = list(&quot;AvgRating&quot;, 3.5, 4.1), color = &quot;blue&quot;, active = T), 
                     list(query = elements, params = list(&quot;ReleaseDate&quot;, 1980, 1990, 2000), color = &quot;red&quot;, active = F)))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-15-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
в гистограме пересечений подсветили интересующие нас конкретные значения среднего рейтинга синим цветом и даты выхода фильмов красным цветом</p>
</blockquote>
<p></br></p>
</div>
<div id="использование-параметра-выражения-для-запросов-к-пересечениям-подмножеств-и-элементам" class="section level3">
<h3>Использование параметра выражения для запросов к пересечениям подмножеств и элементам</h3>
<p>В этом примере показано, как использовать параметр expression для фильтрации подмножества результатов запросов элементов и пересечений.</p>
<pre class="r"><code>upset(movies, 
      queries = list(
        list(query = intersects, params = list(&quot;Action&quot;, &quot;Drama&quot;), active = T), 
        list(query = elements, params = list(&quot;ReleaseDate&quot;, 1980, 1990, 2000), color = &quot;red&quot;, active = F)
        ), 
      expression = &quot;AvgRating &gt; 3 &amp; Watches &gt; 100&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-16-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
Отфильтровали график по условиям средний рейтинг &gt; 3 и количество просмотров &gt; 100
Далее выделили пересечение жанров экшен и драмы
А также красным цветом показали содержащееся в пересечениях количество фильмов с датами выхода 1980, 1990 и 2000</p>
</blockquote>
<p></br></p>
</div>
<div id="создание-пользовательских-запросов-к-элементам-и-атрибутам-набора" class="section level3">
<h3>Создание пользовательских запросов к элементам и атрибутам набора</h3>
<pre class="r"><code>Myfunc &lt;- function(row, release, rating) {
    data &lt;- (row[&quot;ReleaseDate&quot;] %in% release) &amp; (row[&quot;AvgRating&quot;] &gt; rating)
}

upset(movies, 
      queries = list(list(query = Myfunc, params = list(c(1970, 1980, 1990, 1999, 2000), 2.5), 
                          color = &quot;blue&quot;, active = T))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-17-1.png" width="1152" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Читаем график: </br>
На графике подсвечиваем с помощью написанной функции количество фильмов с заданой датой выхода и выше нужного нам рейтинга</p>
</blockquote>
<p></br></p>
</div>
<div id="добавление-легенды" class="section level3">
<h3>Добавление легенды</h3>
<p>Чтобы добавить условные обозначения для примененных запросов, можно использовать параметр <code>query.legend</code>. Параметр <code>query.legend</code> задает положение, в котором должна отображаться легенда, либо сверху, либо снизу. Чтобы применить определенное имя к каждому запросу, параметр <code>query.name</code> может использоваться при определении запроса в параметре запросов. Если <code>query.name</code> не задан, то будет использоваться общее название. В приведенном ниже примере показано, как это сделать.</p>
<pre class="r"><code>upset(movies, 
      query.legend = &quot;top&quot;, 
      queries = list(
        list(query = intersects, params = list(&quot;Drama&quot;, &quot;Comedy&quot;, &quot;Action&quot;), color = &quot;orange&quot;, active = T,
             query.name = &quot;Funny action&quot;), 
        list(query = intersects, params = list(&quot;Drama&quot;), color = &quot;red&quot;, active = F), 
        list(query = intersects, params = list(&quot;Action&quot;, &quot;Drama&quot;), active = T, 
             query.name = &quot;Emotional action&quot;))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-18-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
<p><strong>Объединим примененные выше методы</strong></p>
<pre class="r"><code>upset(movies, 
      query.legend = &quot;bottom&quot;, 
      queries = list(
        list(query = Myfunc, params = list(c(1970, 1980, 1990, 1999, 2000), 2.5), color = &quot;orange&quot;, active = T), 
        list(query = intersects, params = list(&quot;Action&quot;, &quot;Drama&quot;), active = F), 
        list(query = elements, params = list(&quot;ReleaseDate&quot;, 1980, 1990, 2000), color = &quot;red&quot;, active = F,
             query.name = &quot;Decades&quot;)), 
      expression = &quot;AvgRating &gt; 3 &amp; Watches &gt; 100&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-19-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
</div>
<div id="добавление-метаданных-набора-на-график" class="section level3">
<h3>Добавление метаданных набора на график</h3>
<p>Добавление метаданных задается параметром: <code>set.metadata</code></p>
<p>Разберем атрибуты этого параметра:</p>
<ul>
<li><p><code>data</code>: принимает фрейм данных, где первый столбец - это имена наборов, а следующие столбцы - атрибуты наборов.</p></li>
<li><p><code>plots</code>: это список, который принимает список параметров, используемых для создания графиков. Эти параметры включают столбец, тип, назначение и цвета.</p></li>
<li><p><code>column</code>: столбец используемого набора данныхЮ по которому будет строиться график</p></li>
<li><p><code>type</code>: это то, какой тип графика следует использовать для отображения данных из указанного столбца. Если данные в столбце числовые, то тип графика может быть либо гистограммой (“hist”), либо тепловой картой (“heat”). Если данные в столбце являются логическими, то типом графика может быть тепловая карта “bool”. Если данные в столбце являются категориальными (символьными), то тип графика может быть либо тепловой картой (“тепло”), либо текстом (“текст”). Кроме того, если данные в столбце порядковые (коэффициентные), то тип графика может быть либо тепловой картой, либо текстом. Существует также тип под названием “matrix_rows”, который позволяет нам использовать применение цветов к фону матрицы с использованием категориальных данных. Этот тип полезен для определения характеристик наборов с использованием матрицы.</p></li>
<li><p><code>assign</code>: это количество столбцов, которые должны быть назначены конкретному графику. Например, если вы строите 2 набора графиков метаданных, то вы можете выбрать один график, который будет занимать 20 столбцов, а другой - 10 столбцов. Поскольку график смещения обычно наносится на сетку размером 100 на 100, сетка теперь будет иметь размер 100 на 130, где примерно 1/4 участка отводится графикам метаданных.</p></li>
<li><p><code>colors</code>: используется для указания цветов, используемых в графиках метаданных. Если тип графика - линейчатый график, то параметр принимает только один цвет для всего графика. Если тип графика “heat” или “bool”, то может быть предоставлен вектор цветов, в котором для каждой уникальной категории (символа) есть один цвет. Однако, если тип данных порядковый (фактор), ввод цветов отсутствует, и тепловая карта работает с цветовым градиентом, а не применяет разные цвета к каждому уровню. Наконец, если тип графика - “текст”, то может быть предоставлен вектор цветов, где для каждой уникальной строки есть один цвет. Если цвета не указаны, вам будет предоставлена цветовая палитра.</p>
<p>В этом примере в качестве метаданных набора будут использоваться средние рейтинги фильмов Rotten Tomatoes для каждого набора. Это может помочь нам сделать больше выводов из визуализации, зная, как профессиональные рецензенты обычно оценивают фильмы в этих категориях.</p></li>
</ul>
<pre class="r"><code>sets &lt;- names(movies[3:19])
avgRottenTomatoesScore &lt;- round(runif(17, min = 0, max = 90))
metadata &lt;- as.data.frame(cbind(sets, avgRottenTomatoesScore))
names(metadata) &lt;- c(&quot;sets&quot;, &quot;avgRottenTomatoesScore&quot;)

# При создании гистограммы с использованием информации метаданных набора важно убедиться, что указанный столбец является числовым.
is.numeric(metadata$avgRottenTomatoesScore)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<pre class="r"><code># Столбец не является числовым! На самом деле это фактор, поэтому мы должны преобразовать его в символы, а затем в целые числа.
metadata$avgRottenTomatoesScore &lt;- as.numeric(as.character(metadata$avgRottenTomatoesScore))

upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;hist&quot;, column = &quot;avgRottenTomatoesScore&quot;, assign = 20)))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-20-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
</div>
<div id="добавление-тепловой-карты" class="section level3">
<h3>Добавление тепловой карты</h3>
<p>В этом примере мы составим наши собственные данные о том, в каких крупных городах эти жанры были наиболее популярны. Поскольку это категориальный, а не порядковый номер, мы должны не забыть изменить столбец на символы (это снова фактор). Чтобы убедиться, что мы назначаем определенные цвета каждой категории, вы можете указать название каждой категории в цветовом векторе, как показано ниже. Если вам все равно, какой цвет присвоен каждой категории, то вам не нужно указывать названия категорий в цветовом векторе. R просто применит цвета к каждой категории в том порядке, в котором они встречаются. Кроме того, если вы ничего не укажете для параметра colors, вам будет предоставлена цветовая палитра по умолчанию.</p>
<pre class="r"><code>Cities &lt;- sample(c(&quot;Boston&quot;, &quot;NYC&quot;, &quot;LA&quot;), 17, replace = T)
metadata &lt;- cbind(metadata, Cities)
metadata$Cities &lt;- as.character(metadata$Cities)
metadata[which(metadata$sets %in% c(&quot;Drama&quot;, &quot;Comedy&quot;, &quot;Action&quot;, &quot;Thriller&quot;, 
    &quot;Romance&quot;)), ]</code></pre>
<pre><code>##        sets avgRottenTomatoesScore Cities
## 1    Action                     43    NYC
## 4    Comedy                     52 Boston
## 7     Drama                     10    NYC
## 13  Romance                     13     LA
## 15 Thriller                     81     LA</code></pre>
<pre class="r"><code>upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;heat&quot;, column = &quot;Cities&quot;, assign = 10, 
             colors = c(Boston = &quot;green&quot;, NYC = &quot;navy&quot;, LA = &quot;purple&quot;))))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
<p>Теперь давайте также использовать наши числовые значения критики!</p>
<pre class="r"><code>upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;heat&quot;, column = &quot;Cities&quot;, assign = 10, 
             colors = c(Boston = &quot;green&quot;, NYC = &quot;navy&quot;, LA = &quot;purple&quot;)), 
        list(type = &quot;heat&quot;, column = &quot;avgRottenTomatoesScore&quot;, assign = 10)))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-22-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
</div>
<div id="логическая-тепловая-карта" class="section level3">
<h3>Логическая тепловая карта</h3>
<p>Теперь предположим, что у нас есть метаданные, которые сообщают нам, хорошо ли эти жанры приняты за рубежом. Это может быть использовано в качестве категориального столбца, где есть только две категории, но для этого примера мы предположим, что ваши данные закодированы в 1 и 0. Важно иметь в виду, что если вы запустите “heat” с 0 и 1 вместо “bool”, двоичные данные будут обрабатываться как числовые значения, а цветовой градиент будет использоваться для отображения относительных различий.</p>
<pre class="r"><code>accepted &lt;- round(runif(17, min = 0, max = 1))
metadata &lt;- cbind(metadata, accepted)
metadata[which(metadata$sets %in% c(&quot;Drama&quot;, &quot;Comedy&quot;, &quot;Action&quot;, &quot;Thriller&quot;, &quot;Romance&quot;)), ]</code></pre>
<pre><code>##        sets avgRottenTomatoesScore Cities accepted
## 1    Action                     43    NYC        1
## 4    Comedy                     52 Boston        0
## 7     Drama                     10    NYC        0
## 13  Romance                     13     LA        1
## 15 Thriller                     81     LA        1</code></pre>
<pre class="r"><code>upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;bool&quot;, column = &quot;accepted&quot;, assign = 5, colors = c(&quot;#FF3333&quot;, &quot;#006400&quot;))))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-23-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
<p>Давайте посмотрим, что произойдет, когда мы выберем “heat” вместо “bool” для нашего столбца двоичных данных.</p>
<pre class="r"><code>upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;heat&quot;, column = &quot;accepted&quot;, assign = 5, colors = c(&quot;red&quot;, &quot;green&quot;))))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p></br></p>
<p>Допустим, мы предпочитаем показывать текст вместо тепловой карты для городов, в которых эти жанры были наиболее популярны.</p>
<pre class="r"><code>upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;text&quot;, column = &quot;Cities&quot;, assign = 10, 
             colors = c(Boston = &quot;green&quot;, NYC = &quot;navy&quot;, LA = &quot;purple&quot;))))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-25-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
</div>
<div id="применение-метаданных-к-матрице" class="section level3">
<h3>Применение метаданных к матрице</h3>
<p>В некоторых случаях мы можем просто захотеть включить метаданные категориального набора непосредственно в график расслоения, чтобы легко идентифицировать характеристики наборов с помощью матрицы. Для этого нам нужно указать тип как <code>matrix_rows</code>, какой столбец мы используем для категоризации наборов, и цвета, которые будут применяться к каждой категории. Существует также возможность изменить непрозрачность фона матрицы с помощью альфа-кода. Чтобы изменить непрозрачность фона матрицы без применения заданных метаданных, см. параметр <code>shade.alpha</code> в документации к функции <code>disapport()</code>.</p>
<pre class="r"><code>upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;hist&quot;, column = &quot;avgRottenTomatoesScore&quot;, assign = 20), 
        list(type = &quot;matrix_rows&quot;, column = &quot;Cities&quot;, 
             colors = c(Boston = &quot;green&quot;, NYC = &quot;navy&quot;, LA = &quot;purple&quot;), 
    alpha = 0.5)))
    )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-26-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
<p><strong>Объединим методы рассмотренные выше на одном графике</strong></p>
<pre class="r"><code>upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;hist&quot;, column = &quot;avgRottenTomatoesScore&quot;, assign = 20), 
        list(type = &quot;bool&quot;, column = &quot;accepted&quot;, assign = 5, colors = c(&quot;#FF3333&quot;, &quot;#006400&quot;)), 
        list(type = &quot;text&quot;, column = &quot;Cities&quot;, assign = 5, 
             colors = c(Boston = &quot;green&quot;, NYC = &quot;navy&quot;, LA = &quot;purple&quot;))))
      )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-27-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p></br></p>
<p>А теперь соединим методы добавления метаданных, атрибутов и запросов</p>
<pre class="r"><code>upset(movies, 
      set.metadata = list(data = metadata, plots = list(
        list(type = &quot;hist&quot;, column = &quot;avgRottenTomatoesScore&quot;, assign = 20), 
        list(type = &quot;bool&quot;, column = &quot;accepted&quot;, assign = 5, colors = c(&quot;#FF3333&quot;, &quot;#006400&quot;)), 
        list(type = &quot;text&quot;, column = &quot;Cities&quot;,   assign = 5, colors = c(Boston = &quot;green&quot;, NYC = &quot;navy&quot;, LA = &quot;purple&quot;)), 
        list(type = &quot;matrix_rows&quot;, column = &quot;Cities&quot;, colors = c(Boston = &quot;green&quot;, NYC = &quot;navy&quot;, LA = &quot;purple&quot;), 
             alpha = 0.5))), 
      queries = list(list(query = intersects, params = list(&quot;Drama&quot;), color = &quot;red&quot;, active = F), 
                     list(query = intersects, params = list(&quot;Action&quot;, &quot;Drama&quot;), active = T), 
                     list(query = intersects, params = list(&quot;Drama&quot;, &quot;Comedy&quot;, &quot;Action&quot;), 
                          color = &quot;orange&quot;, active = T)), 
      attribute.plots = list(gridrows = 45, plots = list(
        list(plot = scatter_plot, x = &quot;ReleaseDate&quot;, y = &quot;AvgRating&quot;, queries = T), 
        list(plot = scatter_plot, x = &quot;AvgRating&quot;, y = &quot;Watches&quot;, queries = F)), ncols = 2), 
      query.legend = &quot;bottom&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-28-1.png" width="1152" style="display: block; margin: auto;" /></p>
</div>
</div>
